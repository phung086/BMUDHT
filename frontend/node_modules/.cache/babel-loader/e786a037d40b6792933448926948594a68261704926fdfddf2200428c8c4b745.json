{"ast":null,"code":"import axios from \"axios\";\nimport { broadcastAuthChange, clearToken, isTokenExpired, persistToken, readToken, shouldProactivelyRefresh } from \"./authSignal\";\nconst SESSION_EXPIRED_FLAG = \"sessionExpired\";\nlet inFlightRefresh = null;\nexport const ensureFreshAccessToken = async () => {\n  const currentToken = readToken();\n  if (!currentToken) return null;\n  if (!shouldProactivelyRefresh() && !isTokenExpired()) {\n    return currentToken;\n  }\n  if (!inFlightRefresh) {\n    inFlightRefresh = axios.post(\"/api/auth/refresh-token\", {}, {\n      withCredentials: true\n    }).then(response => {\n      var _response$data;\n      const refreshedToken = (_response$data = response.data) === null || _response$data === void 0 ? void 0 : _response$data.accessToken;\n      if (refreshedToken) {\n        persistToken(refreshedToken);\n        broadcastAuthChange();\n        return refreshedToken;\n      }\n      setSessionExpiredFlag();\n      clearToken();\n      broadcastAuthChange();\n      return null;\n    }).catch(error => {\n      setSessionExpiredFlag();\n      clearToken();\n      broadcastAuthChange();\n      throw error;\n    }).finally(() => {\n      inFlightRefresh = null;\n    });\n  }\n  return inFlightRefresh;\n};\nexport const serverLogout = async () => {\n  try {\n    await axios.post(\"/api/auth/logout\", {}, {\n      withCredentials: true\n    });\n  } catch (error) {\n    // ignore network errors during logout\n  }\n};\nexport const setSessionExpiredFlag = () => {\n  try {\n    if (typeof window !== \"undefined\") {\n      window.localStorage.setItem(SESSION_EXPIRED_FLAG, \"1\");\n    }\n  } catch (error) {\n    // ignore quota errors\n  }\n};\nexport const consumeSessionExpiredFlag = () => {\n  if (typeof window === \"undefined\") return false;\n  try {\n    const value = window.localStorage.getItem(SESSION_EXPIRED_FLAG);\n    if (!value) return false;\n    window.localStorage.removeItem(SESSION_EXPIRED_FLAG);\n    return true;\n  } catch (error) {\n    return false;\n  }\n};","map":{"version":3,"names":["axios","broadcastAuthChange","clearToken","isTokenExpired","persistToken","readToken","shouldProactivelyRefresh","SESSION_EXPIRED_FLAG","inFlightRefresh","ensureFreshAccessToken","currentToken","post","withCredentials","then","response","_response$data","refreshedToken","data","accessToken","setSessionExpiredFlag","catch","error","finally","serverLogout","window","localStorage","setItem","consumeSessionExpiredFlag","value","getItem","removeItem"],"sources":["D:/BMUDHT/frontend/src/utils/sessionManager.js"],"sourcesContent":["import axios from \"axios\";\r\nimport {\r\n  broadcastAuthChange,\r\n  clearToken,\r\n  isTokenExpired,\r\n  persistToken,\r\n  readToken,\r\n  shouldProactivelyRefresh,\r\n} from \"./authSignal\";\r\n\r\nconst SESSION_EXPIRED_FLAG = \"sessionExpired\";\r\n\r\nlet inFlightRefresh = null;\r\n\r\nexport const ensureFreshAccessToken = async () => {\r\n  const currentToken = readToken();\r\n  if (!currentToken) return null;\r\n\r\n  if (!shouldProactivelyRefresh() && !isTokenExpired()) {\r\n    return currentToken;\r\n  }\r\n\r\n  if (!inFlightRefresh) {\r\n    inFlightRefresh = axios\r\n      .post(\r\n        \"/api/auth/refresh-token\",\r\n        {},\r\n        {\r\n          withCredentials: true,\r\n        }\r\n      )\r\n      .then((response) => {\r\n        const refreshedToken = response.data?.accessToken;\r\n        if (refreshedToken) {\r\n          persistToken(refreshedToken);\r\n          broadcastAuthChange();\r\n          return refreshedToken;\r\n        }\r\n        setSessionExpiredFlag();\r\n        clearToken();\r\n        broadcastAuthChange();\r\n        return null;\r\n      })\r\n      .catch((error) => {\r\n        setSessionExpiredFlag();\r\n        clearToken();\r\n        broadcastAuthChange();\r\n        throw error;\r\n      })\r\n      .finally(() => {\r\n        inFlightRefresh = null;\r\n      });\r\n  }\r\n\r\n  return inFlightRefresh;\r\n};\r\n\r\nexport const serverLogout = async () => {\r\n  try {\r\n    await axios.post(\r\n      \"/api/auth/logout\",\r\n      {},\r\n      {\r\n        withCredentials: true,\r\n      }\r\n    );\r\n  } catch (error) {\r\n    // ignore network errors during logout\r\n  }\r\n};\r\n\r\nexport const setSessionExpiredFlag = () => {\r\n  try {\r\n    if (typeof window !== \"undefined\") {\r\n      window.localStorage.setItem(SESSION_EXPIRED_FLAG, \"1\");\r\n    }\r\n  } catch (error) {\r\n    // ignore quota errors\r\n  }\r\n};\r\n\r\nexport const consumeSessionExpiredFlag = () => {\r\n  if (typeof window === \"undefined\") return false;\r\n  try {\r\n    const value = window.localStorage.getItem(SESSION_EXPIRED_FLAG);\r\n    if (!value) return false;\r\n    window.localStorage.removeItem(SESSION_EXPIRED_FLAG);\r\n    return true;\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n};\r\n"],"mappings":"AAAA,OAAOA,KAAK,MAAM,OAAO;AACzB,SACEC,mBAAmB,EACnBC,UAAU,EACVC,cAAc,EACdC,YAAY,EACZC,SAAS,EACTC,wBAAwB,QACnB,cAAc;AAErB,MAAMC,oBAAoB,GAAG,gBAAgB;AAE7C,IAAIC,eAAe,GAAG,IAAI;AAE1B,OAAO,MAAMC,sBAAsB,GAAG,MAAAA,CAAA,KAAY;EAChD,MAAMC,YAAY,GAAGL,SAAS,CAAC,CAAC;EAChC,IAAI,CAACK,YAAY,EAAE,OAAO,IAAI;EAE9B,IAAI,CAACJ,wBAAwB,CAAC,CAAC,IAAI,CAACH,cAAc,CAAC,CAAC,EAAE;IACpD,OAAOO,YAAY;EACrB;EAEA,IAAI,CAACF,eAAe,EAAE;IACpBA,eAAe,GAAGR,KAAK,CACpBW,IAAI,CACH,yBAAyB,EACzB,CAAC,CAAC,EACF;MACEC,eAAe,EAAE;IACnB,CACF,CAAC,CACAC,IAAI,CAAEC,QAAQ,IAAK;MAAA,IAAAC,cAAA;MAClB,MAAMC,cAAc,IAAAD,cAAA,GAAGD,QAAQ,CAACG,IAAI,cAAAF,cAAA,uBAAbA,cAAA,CAAeG,WAAW;MACjD,IAAIF,cAAc,EAAE;QAClBZ,YAAY,CAACY,cAAc,CAAC;QAC5Bf,mBAAmB,CAAC,CAAC;QACrB,OAAOe,cAAc;MACvB;MACAG,qBAAqB,CAAC,CAAC;MACvBjB,UAAU,CAAC,CAAC;MACZD,mBAAmB,CAAC,CAAC;MACrB,OAAO,IAAI;IACb,CAAC,CAAC,CACDmB,KAAK,CAAEC,KAAK,IAAK;MAChBF,qBAAqB,CAAC,CAAC;MACvBjB,UAAU,CAAC,CAAC;MACZD,mBAAmB,CAAC,CAAC;MACrB,MAAMoB,KAAK;IACb,CAAC,CAAC,CACDC,OAAO,CAAC,MAAM;MACbd,eAAe,GAAG,IAAI;IACxB,CAAC,CAAC;EACN;EAEA,OAAOA,eAAe;AACxB,CAAC;AAED,OAAO,MAAMe,YAAY,GAAG,MAAAA,CAAA,KAAY;EACtC,IAAI;IACF,MAAMvB,KAAK,CAACW,IAAI,CACd,kBAAkB,EAClB,CAAC,CAAC,EACF;MACEC,eAAe,EAAE;IACnB,CACF,CAAC;EACH,CAAC,CAAC,OAAOS,KAAK,EAAE;IACd;EAAA;AAEJ,CAAC;AAED,OAAO,MAAMF,qBAAqB,GAAGA,CAAA,KAAM;EACzC,IAAI;IACF,IAAI,OAAOK,MAAM,KAAK,WAAW,EAAE;MACjCA,MAAM,CAACC,YAAY,CAACC,OAAO,CAACnB,oBAAoB,EAAE,GAAG,CAAC;IACxD;EACF,CAAC,CAAC,OAAOc,KAAK,EAAE;IACd;EAAA;AAEJ,CAAC;AAED,OAAO,MAAMM,yBAAyB,GAAGA,CAAA,KAAM;EAC7C,IAAI,OAAOH,MAAM,KAAK,WAAW,EAAE,OAAO,KAAK;EAC/C,IAAI;IACF,MAAMI,KAAK,GAAGJ,MAAM,CAACC,YAAY,CAACI,OAAO,CAACtB,oBAAoB,CAAC;IAC/D,IAAI,CAACqB,KAAK,EAAE,OAAO,KAAK;IACxBJ,MAAM,CAACC,YAAY,CAACK,UAAU,CAACvB,oBAAoB,CAAC;IACpD,OAAO,IAAI;EACb,CAAC,CAAC,OAAOc,KAAK,EAAE;IACd,OAAO,KAAK;EACd;AACF,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}